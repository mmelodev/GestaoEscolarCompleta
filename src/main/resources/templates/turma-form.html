<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Turma - Formul√°rio</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" th:href="@{/css/forms.css?v=1.1}" />
    <link rel="stylesheet" th:href="@{/css/header.css?v=2.1}" />
    <link rel="stylesheet" th:href="@{/css/home.css?v=1.0}" />
    <style>
        .help-icon {
            cursor: help;
            font-size: 14px;
            margin-left: 5px;
            opacity: 0.7;
        }
        .help-icon:hover {
            opacity: 1;
        }
        .field select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .modalidade-help {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin-top: 5px;
            font-size: 12px;
            color: #6c757d;
            display: none;
        }
    </style>
</head>
<body>
<header>
    <div class="main-nav" style="margin-bottom: 1rem;">
        <div class="logo">
            <a th:href="@{/}"><img th:src="@{/img/horizontal_negativa.png}" alt="Logo" /></a>
        </div>
        <nav>
            <!-- Bot√£o Hamb√∫rguer - Mobile -->
            <button class="menu-toggle" id="menuToggle" aria-label="Abrir menu" aria-expanded="false" aria-controls="navList">
                <span></span>
                <span></span>
                <span></span>
            </button>

            <ul class="nav-list" id="navList">
                <a th:href="@{/}"><li class="nav-element">Home</li></a>
                <a th:href="@{/alunos/lista}"><li class="nav-element">Alunos</li></a>
                <a th:href="@{/turmas}"><li class="nav-element active">Turmas</li></a>
                <a th:href="@{/cadastro}"><li class="nav-element">Cadastro</li></a>
                <a sec:authorize="isAuthenticated()" th:href="@{/perfil}"><li class="nav-element">Meu Perfil</li></a>
                <a sec:authorize="isAuthenticated()" th:href="@{/configuracao}"><li class="nav-element">üé® Personaliza√ß√£o</li></a>
            </ul>
        </nav>
    </div>
    <div class="menu-overlay" id="menuOverlay" aria-hidden="true"></div>
</header>

<div class="page-container">
    <div class="form-card">
        <h2 style="margin-top:0">Turma</h2>
        <form class="form-root" th:object="${turma}" th:action="@{${isNew} ? '/turmas' : '/turmas/atualizar/' + ${turma.id}}" method="post" enctype="multipart/form-data">
            <!-- CSRF Token -->
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            
            <input type="hidden" th:if="${!isNew}" th:field="*{id}" />
            
            <!-- Preservar alunoIds ao editar -->
            <input type="hidden" th:each="alunoId : ${turma.alunoIds}" 
                   th:name="alunoIds" th:value="${alunoId}" th:if="${!isNew && turma.alunoIds != null}" />

            <div class="row">
                <div class="field">
                    <label>Nome da Turma</label>
                    <input th:field="*{nomeTurma}" placeholder="Nome da Turma" required>
                    <div th:if="${#fields.hasErrors('nomeTurma')}" class="field-error" th:errors="*{nomeTurma}"></div>
                </div>
                <div class="field">
                    <label>Idioma <span style="color: red;">*</span></label>
                    <select id="idiomaSelect" name="idioma" th:field="*{idioma}" required>
                        <option value="">Selecione o idioma</option>
                        <option th:each="idioma : ${idiomasDisponiveis}"
                                th:value="${idioma}"
                                th:text="${idioma}"
                                th:selected="${turma.idioma != null && turma.idioma == idioma}">
                        </option>
                    </select>
                    <div th:if="${#fields.hasErrors('idioma')}" class="field-error" th:errors="*{idioma}"></div>
                    <!-- Campo de texto para "Outro Idioma?" -->
                    <div id="outroIdiomaContainer" style="display: none; margin-top: 10px;">
                        <label for="outroIdiomaInput">Especifique o idioma:</label>
                        <input type="text" 
                               id="outroIdiomaInput" 
                               name="outroIdioma" 
                               placeholder="Digite o idioma"
                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; margin-top: 5px;"
                               th:value="${turma.idioma != null && !#lists.contains(idiomasDisponiveis, turma.idioma) ? turma.idioma : ''}">
                    </div>
                </div>
                <div class="field">
                    <label>Professor Respons√°vel</label>
                    <select th:field="*{professorResponsavelId}">
                        <option value="">Selecione um professor</option>
                        <option th:each="professor : ${professores}"
                                th:value="${professor.id()}"
                                th:text="${professor.nomeCompleto()}"
                                th:selected="${turma.professorResponsavelId != null && turma.professorResponsavelId == professor.id()}">
                        </option>
                    </select>
                </div>
            </div>

            <div class="row">
                <div class="field">
                    <label>N√≠vel de Profici√™ncia</label>
                    <input th:field="*{nivelProficiencia}" placeholder="N√≠vel">
                    <div th:if="${#fields.hasErrors('nivelProficiencia')}" class="field-error" th:errors="*{nivelProficiencia}"></div>
                </div>
                <div class="field">
                    <label>Dia da Turma</label>
                    <input th:field="*{diaTurma}" placeholder="Dia da Semana">
                    <div th:if="${#fields.hasErrors('diaTurma')}" class="field-error" th:errors="*{diaTurma}"></div>
                </div>
            </div>

            <div class="row">
                <div class="field">
                    <label>Turno <span class="help-icon" title="Selecione o per√≠odo de funcionamento da turma">‚ÑπÔ∏è</span></label>
                    <select th:field="*{turno}">
                        <option value="">Selecione o turno</option>
                        <option th:each="turno : ${turnos}" 
                                th:value="${turno.name()}" 
                                th:selected="${turma.turno != null && turma.turno.name() == turno.name()}"
                                th:text="${turno.descricao} + ' (' + ${turno.horario} + ')'">
                        </option>
                    </select>
                    <div th:if="${#fields.hasErrors('turno')}" class="field-error" th:errors="*{turno}"></div>
                </div>
                <div class="field">
                    <label>Formato <span class="help-icon" title="Selecione como as aulas ser√£o ministradas">‚ÑπÔ∏è</span></label>
                    <select th:field="*{formato}">
                        <option value="">Selecione o formato</option>
                        <option th:each="formato : ${formatos}" 
                                th:value="${formato.name()}" 
                                th:selected="${turma.formato != null && turma.formato.name() == formato.name()}"
                                th:text="${formato.descricao}">
                        </option>
                    </select>
                    <div th:if="${#fields.hasErrors('formato')}" class="field-error" th:errors="*{formato}"></div>
                </div>
                <div class="field">
                    <label>Modalidade <span class="help-icon" title="Selecione o tipo de curso">‚ÑπÔ∏è</span></label>
                    <select th:field="*{modalidade}">
                        <option value="">Selecione a modalidade</option>
                        <option th:each="modalidade : ${modalidades}" 
                                th:value="${modalidade.name()}" 
                                th:selected="${turma.modalidade != null && turma.modalidade.name() == modalidade.name()}"
                                th:text="${modalidade.descricao}">
                        </option>
                    </select>
                    <div th:if="${#fields.hasErrors('modalidade')}" class="field-error" th:errors="*{modalidade}"></div>
                    <div id="modalidadeHelp" class="modalidade-help"></div>
                </div>
            </div>

            <div class="row">
                <div class="field">
                    <label>Realizador</label>
                    <input th:field="*{realizador}" placeholder="Realizador">
                    <div th:if="${#fields.hasErrors('realizador')}" class="field-error" th:errors="*{realizador}"></div>
                </div>
                <div class="field">
                    <label>Ano/Semestre</label>
                    <input th:field="*{anoSemestre}" placeholder="AAAA/S">
                    <div th:if="${#fields.hasErrors('anoSemestre')}" class="field-error" th:errors="*{anoSemestre}"></div>
                </div>
            </div>

            <div class="row">
                <div class="field">
                    <label>Hora In√≠cio</label>
                    <input type="time" th:field="*{horaInicio}">
                    <div th:if="${#fields.hasErrors('horaInicio')}" class="field-error" th:errors="*{horaInicio}"></div>
                    <small style="color: #00bfff; font-size: 12px; display: block; margin-top: 5px;">
                        üí° Turno da tarde pode terminar √†s 18h. Turno da noite pode come√ßar √†s 18h.
                    </small>
                </div>
                <div class="field">
                    <label>Hora T√©rmino</label>
                    <input type="time" th:field="*{horaTermino}">
                    <div th:if="${#fields.hasErrors('horaTermino')}" class="field-error" th:errors="*{horaTermino}"></div>
                    <small style="color: #00bfff; font-size: 12px; display: block; margin-top: 5px;">
                        üí° Turmas da tarde podem terminar √†s 18h. Turmas da noite podem come√ßar √†s 18h.
                    </small>
                </div>
                <div class="field">
                    <label>Carga Hor√°ria Total <span style="color: red;">*</span></label>
                    <input type="number" th:field="*{cargaHorariaTotal}" placeholder="Horas" required>
                    <div th:if="${#fields.hasErrors('cargaHorariaTotal')}" class="field-error" th:errors="*{cargaHorariaTotal}"></div>
                </div>
            </div>

            <div class="row">
                <div class="field">
                    <label>Quantidade de Aulas <span style="color: red;">*</span></label>
                    <input type="number" th:field="*{quantidadeAulas}" placeholder="N√∫mero de aulas" required>
                    <div th:if="${#fields.hasErrors('quantidadeAulas')}" class="field-error" th:errors="*{quantidadeAulas}"></div>
                    <small style="color: #00bfff; font-size: 12px; display: block; margin-top: 5px;">
                        üí° Informe a quantidade total de aulas da turma (mesma exig√™ncia da carga hor√°ria).
                    </small>
                </div>
                <div class="field" style="flex: 1;">
                    <label>Calend√°rio PDF <span style="color: red;">*</span></label>
                    <input type="file" name="calendarioPdfFile" accept=".pdf" th:required="${isNew}">
                    <div th:if="${error != null and error.contains('Calend√°rio PDF')}" class="field-error" th:text="${error}"></div>
                    <small style="color: #00bfff; font-size: 12px; display: block; margin-top: 5px;">
                        üí° O calend√°rio PDF √© obrigat√≥rio para criar e ativar uma turma. Fa√ßa o upload do arquivo PDF do calend√°rio.
                    </small>
                    <div th:if="${turma != null and turma.calendarioPdf != null and !isNew}" style="margin-top: 10px;">
                        <a th:href="@{'/turmas/calendario/' + ${turma.id}}" target="_blank" style="color: #00bfff; text-decoration: underline;">
                            üìÑ Ver calend√°rio atual
                        </a>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="field">
                    <label>In√≠cio da Turma</label>
                    <input type="date" th:field="*{inicioTurma}">
                    <div th:if="${#fields.hasErrors('inicioTurma')}" class="field-error" th:errors="*{inicioTurma}"></div>
                </div>
                <div class="field">
                    <label>T√©rmino da Turma</label>
                    <input type="date" th:field="*{terminoTurma}">
                    <div th:if="${#fields.hasErrors('terminoTurma')}" class="field-error" th:errors="*{terminoTurma}"></div>
                </div>
            </div>

            <div class="row">
                <div class="field">
                    <label>Situa√ß√£o da Turma</label>
                    <input th:field="*{situacaoTurma}" placeholder="Situa√ß√£o">
                    <div th:if="${#fields.hasErrors('situacaoTurma')}" class="field-error" th:errors="*{situacaoTurma}"></div>
                </div>
            </div>

            <!-- Campo de Justificativa (apenas para edi√ß√£o) -->
            <div th:if="${!isNew}" class="row" style="background-color: #e7f3ff; padding: 20px; border-radius: 8px; margin: 20px 0; border: 2px solid #2196F3;">
                <div style="width: 100%;">
                    <h3 style="color: #1565C0; margin-top: 0; margin-bottom: 15px;">üìù Auditoria de Altera√ß√£o</h3>
                    <div class="field">
                        <label>Justificativa da Altera√ß√£o <span style="color: red;">*</span></label>
                        <textarea name="justificativa" placeholder="Descreva o motivo da altera√ß√£o (obrigat√≥rio)" 
                                  required 
                                  style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; min-height: 100px; resize: vertical;"></textarea>
                        <small style="color: #1565C0; font-size: 12px; display: block; margin-top: 5px;">
                            üìã Todas as altera√ß√µes s√£o registradas com protocolo para auditoria. A justificativa √© obrigat√≥ria para rastreamento das mudan√ßas.
                        </small>
                    </div>
                </div>
            </div>

            <div class="actions">
                <button type="submit" class="btn-primary">Salvar</button>
                <a th:href="@{/turmas}" class="btn-secondary">Cancelar</a>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const modalidadeSelect = document.querySelector('select[name="modalidade"]');
        const modalidadeHelp = document.getElementById('modalidadeHelp');
        
        // Mapeamento de explica√ß√µes das modalidades
        const modalidadeExplicacoes = {
            'REGULAR': 'Modalidade padr√£o com frequ√™ncia obrigat√≥ria e progress√£o gradual.',
            'INTENSIVO': 'Curso acelerado com carga hor√°ria concentrada para aprendizado r√°pido.',
            'EXTENSIVO': 'Curso com dura√ß√£o prolongada e aprofundamento no conte√∫do.',
            'SEMI_INTENSIVO': 'Modalidade intermedi√°ria entre regular e intensivo.',
            'PREPARATORIO': 'Foco em prepara√ß√£o para exames espec√≠ficos como TOEFL, IELTS.',
            'CONVERSACAO': '√änfase na pr√°tica oral e comunica√ß√£o fluente.',
            'GRAMATICA': 'Foco no estudo estrutural da l√≠ngua inglesa.',
            'BUSINESS': 'Ingl√™s especializado para ambiente corporativo.',
            'ACADEMICO': 'Prepara√ß√£o para estudos em universidades internacionais.',
            'VIAGEM': 'Ingl√™s pr√°tico para turismo e viagens.'
        };
        
        if (modalidadeSelect) {
            modalidadeSelect.addEventListener('change', function() {
                const explicacao = modalidadeExplicacoes[this.value];
                if (explicacao) {
                    modalidadeHelp.textContent = explicacao;
                    modalidadeHelp.style.display = 'block';
                } else {
                    modalidadeHelp.style.display = 'none';
                }
            });
        }
        
        // Controle do campo "Outro Idioma?"
        const idiomaSelect = document.getElementById('idiomaSelect');
        const outroIdiomaContainer = document.getElementById('outroIdiomaContainer');
        const outroIdiomaInput = document.getElementById('outroIdiomaInput');
        const OUTRO_IDIOMA = 'Outro Idioma?';
        
        function toggleOutroIdioma() {
            if (idiomaSelect && outroIdiomaContainer && outroIdiomaInput) {
                if (idiomaSelect.value === OUTRO_IDIOMA) {
                    outroIdiomaContainer.style.display = 'block';
                    outroIdiomaInput.required = true;
                    // Se j√° houver um valor customizado, preencher o campo
                    if (!outroIdiomaInput.value && idiomaSelect.value === OUTRO_IDIOMA) {
                        // Verificar se o idioma atual n√£o est√° na lista de idiomas dispon√≠veis
                        const idiomaAtual = idiomaSelect.value;
                        const idiomasDisponiveis = /*[[${idiomasDisponiveis}]]*/ [];
                        if (idiomaAtual && !idiomasDisponiveis.includes(idiomaAtual)) {
                            outroIdiomaInput.value = idiomaAtual;
                        }
                    }
                } else {
                    outroIdiomaContainer.style.display = 'none';
                    outroIdiomaInput.required = false;
                    outroIdiomaInput.value = '';
                }
            }
        }
        
        // Sincronizar valor do campo de texto com o select antes do submit
        const form = document.querySelector('form.form-root');
        if (form) {
            form.addEventListener('submit', function(e) {
                if (idiomaSelect && outroIdiomaInput) {
                    if (idiomaSelect.value === OUTRO_IDIOMA) {
                        if (!outroIdiomaInput.value || outroIdiomaInput.value.trim() === '') {
                            e.preventDefault();
                            alert('Por favor, especifique o idioma no campo de texto.');
                            outroIdiomaInput.focus();
                            return false;
                        }
                        // Atualizar o valor do select com o idioma digitado
                        idiomaSelect.value = outroIdiomaInput.value.trim();
                    }
                }
            });
        }
        
        // Verificar estado inicial ao carregar a p√°gina
        if (idiomaSelect && outroIdiomaContainer && outroIdiomaInput) {
            // Obter o valor inicial do idioma (pode vir do Thymeleaf)
            const idiomaInicial = /*[[${turma != null ? turma.idioma : ''}]]*/ '';
            const idiomasDisponiveis = /*[[${idiomasDisponiveis}]]*/ [];
            
            // Verificar se o idioma inicial n√£o est√° na lista de idiomas dispon√≠veis
            if (idiomaInicial && idiomaInicial !== '' && idiomaInicial !== OUTRO_IDIOMA && !idiomasDisponiveis.includes(idiomaInicial)) {
                // √â um idioma customizado, selecionar "Outro Idioma?" e preencher o campo
                idiomaSelect.value = OUTRO_IDIOMA;
                outroIdiomaInput.value = idiomaInicial;
                toggleOutroIdioma();
            } else {
                // Verificar se o valor atual do select √© "Outro Idioma?"
                if (idiomaSelect.value === OUTRO_IDIOMA) {
                    toggleOutroIdioma();
                } else {
                    toggleOutroIdioma();
                }
            }
        }
        
        // Adicionar listener para mudan√ßas no select
        if (idiomaSelect) {
            idiomaSelect.addEventListener('change', toggleOutroIdioma);
        }
    });
</script>

<script th:src="@{/js/mobile-menu.js?v=1.0}" defer></script>
</body>
</html>