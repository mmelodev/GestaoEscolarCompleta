<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Crachá do Aluno</title>
    <link rel="stylesheet" th:href="@{/css/alunos.css?v=1.2}" />
    <style>
        .cracha-container { display:flex; flex-direction:column; align-items:center; gap:16px; padding:20px; }
        .cracha-card { width: 340px; height: 520px; background: #1a1a1a; color:#fff; border-radius: 20px; position: relative; overflow: hidden; box-shadow: 0 8px 20px rgba(0,0,0,0.35); }
        .cracha-header { background: linear-gradient(90deg, #01004e, #860213); height: 120px; display:flex; align-items:center; justify-content:center; }
        .cracha-header img { height: 64px; }
        .cracha-photo { position: absolute; top: 80px; left: calc(50% - 70px); width: 140px; height: 140px; border-radius: 50%; border: 4px solid #00bfff; background:#222; overflow:hidden; clip-path: circle(50% at 50% 50%); }
        .cracha-photo img { width:100%; height:100%; object-fit: cover; clip-path: circle(50% at 50% 50%); }
        .cracha-body { position:absolute; top: 240px; left:0; right:0; padding: 0 20px; }
        .field { margin-bottom: 10px; }
        .label { color:#00bfff; font-size: 12px; letter-spacing: .08em; text-transform: uppercase; }
        .value { font-size: 18px; font-weight: 700; }
        .btn-row { display:flex; gap:10px; }
        .korean { font-size: 16px; color:#9ae6ff; }

        /* Mobile */
        @media (max-width: 480px) {
            .cracha-container { padding: 14px; }
            .btn-row { flex-direction: column; width: 100%; }
            .btn-row .btn { width: 100%; text-align: center; }
            #fotoInput { width: 100%; }
            .cracha-card { width: min(340px, 100%); }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
<div class="cracha-container">
    <!-- Mensagens de sucesso/erro -->
    <div th:if="${success != null}" class="alert alert-success" style="background-color: #d4edda; color: #155724; padding: 12px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #c3e6cb;">
        <strong>Sucesso!</strong> <span th:text="${success}"></span>
    </div>
    <div th:if="${error != null}" class="alert alert-error" style="background-color: #f8d7da; color: #721c24; padding: 12px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #f5c6cb;">
        <strong>Erro!</strong> <span th:text="${error}"></span>
    </div>
    
    <form th:action="@{'/cracha/' + ${aluno.id} + '/upload'}" method="post" enctype="multipart/form-data" class="btn-row" id="uploadForm">
        <!-- CSRF Token -->
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <input type="file" name="foto" id="fotoInput" accept="image/jpeg,image/jpg,image/png,image/gif,image/webp" required 
               onchange="validateFileSize(this)" />
        <small style="display: block; margin-top: 5px; color: #666; font-size: 0.9em;">
            Formatos permitidos: JPG, PNG, GIF, WEBP. Tamanho máximo: 5MB
        </small>
        <button class="btn cadastrar" type="submit" id="submitBtn">Enviar Foto</button>
        <a th:href="@{/alunos/lista}" class="btn turma">Voltar</a>
    </form>
    
    <script>
        function validateFileSize(input) {
            const maxSize = 5 * 1024 * 1024; // 5MB em bytes
            const file = input.files[0];
            const submitBtn = document.getElementById('submitBtn');
            
            if (file) {
                if (file.size > maxSize) {
                    alert('Arquivo muito grande! Tamanho máximo permitido: 5MB');
                    input.value = '';
                    submitBtn.disabled = true;
                    return false;
                }
                
                // Validar extensão
                const allowedExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp'];
                const fileName = file.name.toLowerCase();
                const hasValidExtension = allowedExtensions.some(ext => fileName.endsWith(ext));
                
                if (!hasValidExtension) {
                    alert('Formato de arquivo não permitido! Use apenas: JPG, PNG, GIF ou WEBP');
                    input.value = '';
                    submitBtn.disabled = true;
                    return false;
                }
                
                submitBtn.disabled = false;
            }
            return true;
        }
        
        // Validar antes do submit
        document.getElementById('uploadForm').addEventListener('submit', function(e) {
            const fileInput = document.getElementById('fotoInput');
            if (!validateFileSize(fileInput)) {
                e.preventDefault();
                return false;
            }
        });
    </script>

    <div class="cracha-card">
        <div class="cracha-header">
            <img th:src="@{/img/horizontal_negativa.png}" alt="Logo" />
        </div>
        <div class="cracha-photo">
            <img th:src="${fotoUrl}" alt="Foto do aluno" onerror="this.style.display='none'"/>
        </div>
        <div class="cracha-body">
            <div class="field"><div class="label">Nome</div><div class="value" th:text="${aluno.nomeCompleto}"></div></div>
            <div class="field"><div class="label">Turmas</div>
                <div class="value" th:text="${aluno.turmas != null ? #strings.listJoin(aluno.turmas.![nomeTurma], ', ') : 'Nenhuma turma'}"></div>
            </div>
            <div class="field"><div class="label">Professor</div>
                <div class="value">Não atribuído</div>
            </div>
            <div class="field"><div class="label">Nível</div>
                <div class="value" th:text="${aluno.turmas != null ? #strings.listJoin(aluno.turmas.![nivelProficiencia], ', ') : 'Nenhum nível'}"></div>
            </div>
            <div class="field"><div class="label">Nome (KO)</div>
                <div class="value korean" th:text="${aluno.nomeSocial != null && !aluno.nomeSocial.isEmpty() ? aluno.nomeSocial : aluno.nomeCompleto}"></div>
            </div>
        </div>
    </div>

    <div class="btn-row">
        <button class="btn cadastrar" type="button" onclick="baixarJPG()">Baixar JPG</button>
        <button class="btn editar" type="button" onclick="baixarPDF()">Baixar PDF</button>
    </div>
</div>

<script>
  async function renderCanvas() {
    const node = document.querySelector('.cracha-card');
    return await html2canvas(node, {backgroundColor: null, scale: 2});
  }
  async function baixarJPG() {
    const canvas = await renderCanvas();
    const link = document.createElement('a');
    link.download = 'cracha.jpg';
    link.href = canvas.toDataURL('image/jpeg', 0.95);
    link.click();
  }
  async function baixarPDF() {
    const canvas = await renderCanvas();
    const imgData = canvas.toDataURL('image/jpeg', 0.95);
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: [340, 520] });
    pdf.addImage(imgData, 'JPEG', 0, 0, 340, 520);
    pdf.save('cracha.pdf');
  }
</script>
</body>
</html>


