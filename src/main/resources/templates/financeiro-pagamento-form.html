<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Registrar Pagamento - AriranG Financeiro</title>
    <link rel="stylesheet" th:href="@{/css/alunos.css?v=1.2}" />
    <link rel="stylesheet" th:href="@{/css/header.css}" />
</head>
<body>
<header>
    <div class="main-nav">
        <div class="logo">
            <a th:href="@{/}"><img th:src="@{/img/horizontal_negativa.png}" alt="Logo" /></a>
        </div>
        <nav>
            <ul class="nav-list" id="navList">
                <a th:href="@{/}"><li class="nav-element">Home</li></a>
                <a th:href="@{/alunos/lista}"><li class="nav-element">Alunos</li></a>
                <a th:href="@{/turmas}"><li class="nav-element">Turmas</li></a>
                <a th:href="@{/contratos}"><li class="nav-element">Contratos</li></a>
                <a th:href="@{/financeiro}"><li class="nav-element active">Financeiro</li></a>
                <a th:href="@{/cadastro}"><li class="nav-element">Cadastro</li></a>
                <a sec:authorize="isAuthenticated()" th:href="@{/perfil}"><li class="nav-element">Meu Perfil</li></a>
                <a sec:authorize="isAuthenticated()" th:href="@{/configuracao}"><li class="nav-element">üé® Personaliza√ß√£o</li></a>
            </ul>
        </nav>
    </div>
</header>

<main>
    <section class="alunos-header">
        <h1>Registrar Pagamento</h1>
        <div class="top-actions">
            <a th:href="@{/financeiro/pagamentos}" class="btn cadastrar">üìã Lista de Pagamentos</a>
            <a th:href="@{/financeiro}" class="btn turma">üìä Dashboard</a>
        </div>
    </section>

    <div class="tabela-container" style="max-width: 900px; margin: 20px auto;">
        <!-- Informa√ß√µes do Aluno e Receita/Mensalidade (quando vem de mensalidades ou com receitaId) -->
        <div th:if="${receita != null}" style="background-color: rgba(26, 26, 26, 0.95); padding: 25px; border-radius: 1rem; margin-bottom: 25px; border-left: 4px solid #007bff;">
            <h2 style="color: aliceblue !important; text-decoration: none !important; margin: 0 0 20px 0; font-size: 20px;">üìã Informa√ß√µes do Pagamento</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                <div style="background-color: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 0.5rem;">
                    <div style="color: #00bfff; font-weight: bold; margin-bottom: 5px; font-size: 12px;">üë§ ALUNO</div>
                    <div style="color: aliceblue !important; text-decoration: none !important; font-size: 18px; font-weight: bold;" 
                         th:text="${receita.alunoNome}">Jo√£o Silva</div>
                </div>
                <div style="background-color: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 0.5rem;">
                    <div style="color: #00bfff; font-weight: bold; margin-bottom: 5px; font-size: 12px;">üí∞ VALOR TOTAL</div>
                    <div style="color: #28a745; font-size: 20px; font-weight: bold;" 
                         th:text="${#numbers.formatCurrency(receita.valorFinal)}">R$ 300,00</div>
                </div>
                <div style="background-color: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 0.5rem;">
                    <div style="color: #00bfff; font-weight: bold; margin-bottom: 5px; font-size: 12px;">üìÖ VENCIMENTO</div>
                    <div style="color: aliceblue !important; text-decoration: none !important; font-size: 16px;" 
                         th:text="${#temporals.format(receita.dataVencimento, 'dd/MM/yyyy')}">01/12/2024</div>
                </div>
                <div style="background-color: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 0.5rem;">
                    <div style="color: #00bfff; font-weight: bold; margin-bottom: 5px; font-size: 12px;">üíµ VALOR A PAGAR</div>
                    <div style="color: #ffc107; font-size: 20px; font-weight: bold;" 
                         th:text="${#numbers.formatCurrency(receita.valorRestante)}">R$ 300,00</div>
                </div>
            </div>
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                <div style="color: #00bfff; font-weight: bold; margin-bottom: 5px; font-size: 12px;">üìç ENDERE√áO DO ALUNO</div>
                <div style="color: aliceblue !important; text-decoration: none !important;">
                    <th:block th:if="${aluno != null and aluno.endereco != null}">
                        <span th:if="${aluno.endereco.logradouro != null and !aluno.endereco.logradouro.isEmpty()}" th:text="${aluno.endereco.logradouro}">Rua Exemplo</span><span th:if="${aluno.endereco.numero != null and !aluno.endereco.numero.isEmpty()}" th:text="${', n¬∫ ' + aluno.endereco.numero}">, 123</span><span th:if="${aluno.endereco.complemento != null and !aluno.endereco.complemento.isEmpty()}" th:text="${' - ' + aluno.endereco.complemento}"> - Sala 1</span><span th:if="${aluno.endereco.bairro != null and !aluno.endereco.bairro.isEmpty()}" th:text="${'. ' + aluno.endereco.bairro}">. Centro</span><span th:if="${aluno.endereco.cidade != null and !aluno.endereco.cidade.isEmpty()}"><span th:if="${aluno.endereco.estado != null and !aluno.endereco.estado.isEmpty()}" th:text="${'. ' + aluno.endereco.cidade + ' - ' + aluno.endereco.estado}">. Manaus - AM</span><span th:unless="${aluno.endereco.estado != null and !aluno.endereco.estado.isEmpty()}" th:text="${'. ' + aluno.endereco.cidade}">. Manaus</span></span><span th:if="${aluno.endereco.cep != null and !aluno.endereco.cep.isEmpty()}" th:text="${'. CEP: ' + aluno.endereco.cep}">. CEP: 69000-000</span>
                    </th:block>
                    <span th:unless="${aluno != null and aluno.endereco != null}">‚Äî</span>
                </div>
            </div>
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                <div style="color: #00bfff; font-weight: bold; margin-bottom: 5px; font-size: 12px;">üìù DESCRI√á√ÉO</div>
                <div style="color: aliceblue !important; text-decoration: none !important;" 
                     th:text="${receita.descricao != null ? receita.descricao : receita.tipoReceita}">Mensalidade 1/6</div>
            </div>
        </div>

        <!-- Seletor de Aluno (quando acessado pelo dashboard sem receita) -->
        <div th:if="${receita == null}" style="background-color: rgba(26, 26, 26, 0.95); padding: 25px; border-radius: 1rem; margin-bottom: 25px; border-left: 4px solid #ffc107;">
            <h2 style="color: aliceblue !important; text-decoration: none !important; margin: 0 0 20px 0; font-size: 20px;">üë§ Selecionar Aluno e Valor</h2>
            <div class="form-group" style="margin-bottom: 15px;">
                <label for="alunoSelect" style="color: #00bfff; font-weight: bold; margin-bottom: 10px; display: block;">Aluno *</label>
                <select id="alunoSelect" name="alunoId" onchange="carregarReceitasAluno(this.value)">
                    <option value="">Selecione um aluno...</option>
                    <option th:each="aluno : ${alunos}" 
                            th:value="${aluno.id}" 
                            th:text="${aluno.nomeCompleto}"></option>
                </select>
            </div>
            <div id="receitasAluno" style="display: none; margin-top: 20px;">
                <label for="receitaSelect" style="color: #00bfff; font-weight: bold; margin-bottom: 10px; display: block;">Receita Pendente *</label>
                <select id="receitaSelect" name="receitaId" onchange="carregarDetalhesReceita(this.value)">
                    <option value="">Selecione uma receita...</option>
                </select>
            </div>
            <div id="detalhesReceita" style="display: none; margin-top: 20px; padding: 15px; background-color: rgba(255, 255, 255, 0.05); border-radius: 0.5rem;">
                <!-- Detalhes da receita ser√£o carregados aqui via JavaScript -->
            </div>
        </div>
        
        <form th:action="@{/financeiro/pagamentos}" 
              th:object="${pagamento}" method="post" class="payment-form" style="background-color: rgba(26, 26, 26, 0.95); padding: 25px; border-radius: 1rem;">
            <!-- CSRF Token -->
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            
            <!-- Campo oculto para receitaId quando selecionado via aluno ou quando vem de mensalidade -->
            <input type="hidden" id="receitaIdHidden" name="receitaId" th:value="${receita != null ? receita.id : ''}" />
            <!-- Campo oculto para parcelaId quando vem de mensalidades -->
            <input type="hidden" id="parcelaIdHidden" name="parcelaId" th:if="${parcelaId != null}" th:value="${parcelaId}" />
            <!-- Campos ocultos para isParcial e isIntegral (ser√£o calculados via JavaScript) -->
            <input type="hidden" id="isParcialHidden" name="isParcial" value="false" />
            <input type="hidden" id="isIntegralHidden" name="isIntegral" value="false" />
            
            <!-- Dados do Pagamento -->
            <div style="margin-bottom: 25px;">
                <h3 style="color: aliceblue !important; text-decoration: none !important; margin: 0 0 20px 0; font-size: 18px; border-bottom: 2px solid #007bff; padding-bottom: 10px;">üí≥ Dados do Pagamento</h3>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label for="valorPago" style="color: #00bfff; font-weight: bold; margin-bottom: 10px; display: block;">Valor Pago (R$) *</label>
                        <input type="number" id="valorPago" name="valorPago" required 
                               step="0.01" min="0" th:field="*{valorPago}" 
                               th:max="${receita != null ? receita.valorRestante : null}"
                               th:value="${pagamento != null and pagamento.valorPago != null ? pagamento.valorPago : (receita != null ? receita.valorRestante : null)}"
                               placeholder="0,00" />
                        <small style="color: #888; font-size: 12px; margin-top: 5px; display: block;" th:if="${receita != null}">
                            M√°ximo: <span th:text="${#numbers.formatCurrency(receita.valorRestante)}">R$ 300,00</span> ¬∑ Use desconto para 100% ou valores pontuais
                        </small>
                        <span class="error" style="color: #dc3545; font-size: 12px; margin-top: 5px; display: block;" th:if="${#fields.hasErrors('valorPago')}" th:errors="*{valorPago}"></span>
                    </div>
                    
                    <div class="form-group">
                        <label for="dataPagamento" style="color: #00bfff; font-weight: bold; margin-bottom: 10px; display: block;">Data do Pagamento *</label>
                        <input type="date" id="dataPagamento" name="dataPagamento" required th:field="*{dataPagamento}" />
                        <span class="error" style="color: #dc3545; font-size: 12px; margin-top: 5px; display: block;" th:if="${#fields.hasErrors('dataPagamento')}" th:errors="*{dataPagamento}"></span>
                    </div>
                </div>

                <!-- Desconto (opcional): percentual ou valor fixo. Ao preencher, Valor Pago √© recalculado. -->
                <div th:if="${receita != null}" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; padding: 15px; background: rgba(0, 191, 255, 0.08); border-radius: 0.5rem; border: 1px solid rgba(0, 191, 255, 0.2);">
                    <div class="form-group">
                        <label for="descontoPercentual" style="color: #00bfff; font-weight: bold; margin-bottom: 10px; display: block;">Desconto (%)</label>
                        <input type="number" id="descontoPercentual" name="descontoPercentual" 
                               step="0.01" min="0" max="100" placeholder="Ex: 100"
                               th:value="${pagamento != null and pagamento.descontoPercentual != null ? pagamento.descontoPercentual : ''}" />
                        <small style="color: #888; font-size: 11px;">Ex.: 100 = 100%</small>
                    </div>
                    <div class="form-group">
                        <label for="descontoValor" style="color: #00bfff; font-weight: bold; margin-bottom: 10px; display: block;">Desconto (R$)</label>
                        <input type="number" id="descontoValor" name="descontoValor" 
                               step="0.01" min="0" placeholder="Ex: 50,00"
                               th:value="${pagamento != null and pagamento.descontoValor != null ? pagamento.descontoValor : ''}" />
                        <small style="color: #888; font-size: 11px;">Valor fixo</small>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <!-- Campo Tipo de Pagamento - Oculto quando vier de mensalidade -->
                    <div class="form-group" id="tipoPagamentoGroup" th:style="${parcelaId == null and receita == null} ? 'display: block;' : 'display: none;'">
                        <label for="tipoPagamento" style="color: #00bfff; font-weight: bold; margin-bottom: 10px; display: block;">Tipo de Pagamento *</label>
                        <select id="tipoPagamento" name="tipoPagamento" th:required="${parcelaId == null and receita == null}">
                            <option value="">Selecione o tipo</option>
                            <option value="MENSALIDADE">üìö Mensalidade</option>
                            <option value="MATERIAL">üìñ Material</option>
                            <option value="OUTROS">üìã Outros</option>
                        </select>
                        <small style="color: #888; font-size: 12px; margin-top: 5px; display: block;">Selecione o tipo de pagamento</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="formaPagamento" style="color: #00bfff; font-weight: bold; margin-bottom: 10px; display: block;">Forma de Pagamento *</label>
                        <select id="formaPagamento" name="formaPagamento" required th:field="*{formaPagamento}">
                            <option value="">Selecione a forma de pagamento</option>
                            <option value="DINHEIRO">üí∞ Dinheiro</option>
                            <option value="PIX">üì± PIX</option>
                            <option value="CARTAO_DEBITO">üí≥ Cart√£o de D√©bito</option>
                            <option value="CARTAO_CREDITO">üí≥ Cart√£o de Cr√©dito</option>
                            <option value="BOLETO">üìÑ Boleto</option>
                            <option value="TRANSFERENCIA">üè¶ Transfer√™ncia</option>
                        </select>
                        <span class="error" style="color: #dc3545; font-size: 12px; margin-top: 5px; display: block;" th:if="${#fields.hasErrors('formaPagamento')}" th:errors="*{formaPagamento}"></span>
                    </div>
                    
                    <div class="form-group">
                        <label for="numeroTransacao" style="color: #00bfff; font-weight: bold; margin-bottom: 10px; display: block;">N√∫mero da Transa√ß√£o</label>
                        <input type="text" id="numeroTransacao" name="numeroTransacao" 
                               th:field="*{numeroTransacao}" 
                               placeholder="Ex: 123456789 (opcional)" />
                        <small style="color: #888; font-size: 12px; margin-top: 5px; display: block;">Para PIX, cart√£o ou transfer√™ncia</small>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="observacoes" style="color: #00bfff; font-weight: bold; margin-bottom: 10px; display: block;">Observa√ß√µes</label>
                    <textarea id="observacoes" name="observacoes" 
                              rows="3" th:field="*{observacoes}" 
                              placeholder="Informa√ß√µes adicionais sobre o pagamento..."></textarea>
                </div>
            </div>
            
            <!-- Resumo do Pagamento -->
            <div style="background-color: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 0.5rem; margin-bottom: 25px;">
                <h3 style="color: aliceblue !important; text-decoration: none !important; margin: 0 0 20px 0; font-size: 18px; border-bottom: 2px solid #28a745; padding-bottom: 10px;">üìä Resumo do Pagamento</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div>
                        <div style="color: #888; font-size: 12px; margin-bottom: 5px;">Valor Pago:</div>
                        <div style="color: aliceblue !important; text-decoration: none !important; font-size: 20px; font-weight: bold;" id="valorPagoDisplay">R$ 0,00</div>
                    </div>
                    <div th:if="${receita != null}" id="resumoDescontoWrap" style="display: none;">
                        <div style="color: #888; font-size: 12px; margin-bottom: 5px;">Desconto aplicado:</div>
                        <div style="color: #17a2b8; font-size: 18px; font-weight: bold;" id="resumoDesconto">‚Äî</div>
                    </div>
                    <div th:if="${receita != null}">
                        <div style="color: #888; font-size: 12px; margin-bottom: 5px;">Valor Restante:</div>
                        <div style="color: #ffc107; font-size: 20px; font-weight: bold;" id="valorRestanteDisplay" 
                             th:text="${#numbers.formatCurrency(receita.valorRestante)}">R$ 300,00</div>
                    </div>
                    <div th:if="${receita != null}">
                        <div style="color: #888; font-size: 12px; margin-bottom: 5px;">Ap√≥s Pagamento:</div>
                        <div style="color: aliceblue !important; text-decoration: none !important; font-size: 20px; font-weight: bold;" id="valorAposPagamento">R$ 300,00</div>
                    </div>
                    <div th:if="${receita != null}">
                        <div style="color: #888; font-size: 12px; margin-bottom: 5px;">Status:</div>
                        <div style="font-size: 18px; font-weight: bold;" id="statusPagamento">Parcial</div>
                    </div>
                </div>
            </div>
            
            <!-- Bot√µes -->
            <div style="text-align: center; margin-top: 30px;">
                <button type="submit" id="btnRegistrarPagamento" class="btn cadastrar" style="margin-right: 10px;">
                    üí≥ Registrar Pagamento
                </button>
                <a th:href="@{/financeiro/mensalidades}" class="btn editar">Cancelar</a>
            </div>
        </form>
    </div>
</main>

<footer></footer>

<!-- Modal de Erro/Sucesso -->
<div id="messageModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h3 id="messageTitle"></h3>
        <p id="messageText"></p>
        <button onclick="fecharModal()" class="btn">OK</button>
    </div>
</div>

<style>
/* Estilo padr√£o para todos os campos de entrada */
.payment-form input[type="text"],
.payment-form input[type="number"],
.payment-form input[type="date"],
.payment-form select,
.payment-form textarea {
    padding: 10px 20px !important;
    border-radius: 2rem !important;
    border: 1px solid #333 !important;
    outline: none;
    font-size: 1em;
    background-color: #1a1a1a !important;
    color: aliceblue !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2) inset;
    width: 100%;
    box-sizing: border-box;
}

.payment-form input[type="text"]:focus,
.payment-form input[type="number"]:focus,
.payment-form input[type="date"]:focus,
.payment-form select:focus,
.payment-form textarea:focus {
    border-color: #00bfff !important;
    box-shadow: 0 0 0 2px rgba(0, 191, 255, 0.25), 0 2px 4px rgba(0,0,0,0.2) inset;
}

.payment-form select {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-image: linear-gradient(45deg, transparent 50%, #00bfff 50%),
                      linear-gradient(135deg, #00bfff 50%, transparent 50%);
    background-position: calc(100% - 18px) calc(50% - 3px), calc(100% - 12px) calc(50% - 3px);
    background-size: 6px 6px, 6px 6px;
    background-repeat: no-repeat;
    padding-right: 34px;
}

.payment-form textarea {
    resize: vertical;
    min-height: 80px;
}

/* Estilo para o seletor de aluno tamb√©m */
#alunoSelect,
#receitaSelect {
    padding: 10px 20px !important;
    border-radius: 2rem !important;
    border: 1px solid #333 !important;
    outline: none;
    font-size: 1em;
    background-color: #1a1a1a !important;
    color: aliceblue !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2) inset;
    width: 100%;
    box-sizing: border-box;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-image: linear-gradient(45deg, transparent 50%, #00bfff 50%),
                      linear-gradient(135deg, #00bfff 50%, transparent 50%);
    background-position: calc(100% - 18px) calc(50% - 3px), calc(100% - 12px) calc(50% - 3px);
    background-size: 6px 6px, 6px 6px;
    background-repeat: no-repeat;
    padding-right: 34px;
}

#alunoSelect:focus,
#receitaSelect:focus {
    border-color: #00bfff !important;
    box-shadow: 0 0 0 2px rgba(0, 191, 255, 0.25), 0 2px 4px rgba(0,0,0,0.2) inset;
}

.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
}

.modal-content {
    background-color: #fefefe;
    padding: 20px;
    border-radius: 8px;
    max-width: 400px;
    width: 90%;
    text-align: center;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.modal-content h3,
.modal-content p {
    color: #1a1a1a !important;
    text-decoration: none !important;
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    text-decoration: none !important;
}

.close:hover {
    color: black;
}

@media (max-width: 768px) {
    .tabela-container {
        margin: 10px;
        padding: 15px;
    }
}
</style>

<script th:inline="javascript">
/*<![CDATA[*/
// Fun√ß√£o para calcular campos ocultos antes de enviar o formul√°rio (deve estar no escopo global)
function calcularCamposOcultos() {
    const valorPagoInput = document.getElementById('valorPago');
    const valorRestanteDisplay = document.getElementById('valorRestanteDisplay');
    const isParcialHidden = document.getElementById('isParcialHidden');
    const isIntegralHidden = document.getElementById('isIntegralHidden');
    
    if (valorPagoInput && valorRestanteDisplay && isParcialHidden && isIntegralHidden) {
        const valorPago = parseFloat(valorPagoInput.value) || 0;
        // Melhorar parsing do valor restante (remover todos os pontos e substituir v√≠rgula por ponto)
        const valorRestanteText = valorRestanteDisplay.textContent.replace('R$', '').trim();
        const valorRestante = parseFloat(valorRestanteText.replace(/\./g, '').replace(',', '.')) || 0;
        
        // Calcular se √© parcial ou integral
        const valorApos = Math.max(0, valorRestante - valorPago);
        
        if (valorApos <= 0) {
            // Pagamento integral
            isParcialHidden.value = 'false';
            isIntegralHidden.value = 'true';
        } else {
            // Pagamento parcial
            isParcialHidden.value = 'true';
            isIntegralHidden.value = 'false';
        }
    }
    
    return true;
}

// Lista de alunos e receitas (para uso quando n√£o h√° receita pr√©-selecionada)
const alunos = /*[[${alunos}]]*/ [];
const receitasPorAluno = /*[[${receitasPorAluno}]]*/ {};

// Fun√ß√£o para carregar receitas do aluno selecionado
function carregarReceitasAluno(alunoId) {
    const receitasSelect = document.getElementById('receitasAluno');
    const receitaSelect = document.getElementById('receitaSelect');
    const detalhesReceita = document.getElementById('detalhesReceita');
    
    if (!alunoId) {
        receitasSelect.style.display = 'none';
        detalhesReceita.style.display = 'none';
        receitaSelect.innerHTML = '<option value="">Selecione uma receita...</option>';
        return;
    }
    
    // Buscar receitas do aluno via AJAX
    fetch('/financeiro/receitas/aluno/' + alunoId)
        .then(response => response.json())
        .then(receitas => {
            receitaSelect.innerHTML = '<option value="">Selecione uma receita...</option>';
            
            receitas.forEach(receita => {
                const option = document.createElement('option');
                option.value = receita.id;
                const descricao = receita.descricao || receita.tipoReceita || 'Receita';
                const valor = receita.valorFinal || 0;
                option.textContent = descricao + ' - ' + new Intl.NumberFormat('pt-BR', {style: 'currency', currency: 'BRL'}).format(valor);
                option.dataset.receita = JSON.stringify(receita);
                receitaSelect.appendChild(option);
            });
            
            receitasSelect.style.display = receitas.length > 0 ? 'block' : 'none';
        })
        .catch(error => {
            console.error('Erro ao carregar receitas:', error);
        });
}

// Fun√ß√£o para carregar detalhes da receita selecionada
function carregarDetalhesReceita(receitaId) {
    const detalhesReceita = document.getElementById('detalhesReceita');
    const receitaSelect = document.getElementById('receitaSelect');
    const receitaIdHidden = document.getElementById('receitaIdHidden');
    
    if (!receitaId) {
        detalhesReceita.style.display = 'none';
        receitaIdHidden.value = '';
        return;
    }
    
    const option = receitaSelect.querySelector('option[value="' + receitaId + '"]');
    if (option && option.dataset.receita) {
        const receita = JSON.parse(option.dataset.receita);
        receitaIdHidden.value = receitaId;
        
        const valorFinal = receita.valorFinal || 0;
        const valorRestante = receita.valorRestante || valorFinal;
        const dataVencimento = receita.dataVencimento ? new Date(receita.dataVencimento).toLocaleDateString('pt-BR') : 'N/A';
        
        detalhesReceita.innerHTML = `
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div>
                    <div style="color: #00bfff; font-weight: bold; margin-bottom: 5px; font-size: 12px;">üí∞ VALOR TOTAL</div>
                    <div style="color: #28a745; font-size: 18px; font-weight: bold;">${new Intl.NumberFormat('pt-BR', {style: 'currency', currency: 'BRL'}).format(valorFinal)}</div>
                </div>
                <div>
                    <div style="color: #00bfff; font-weight: bold; margin-bottom: 5px; font-size: 12px;">üíµ VALOR RESTANTE</div>
                    <div style="color: #ffc107; font-size: 18px; font-weight: bold;">${new Intl.NumberFormat('pt-BR', {style: 'currency', currency: 'BRL'}).format(valorRestante)}</div>
                </div>
                <div>
                    <div style="color: #00bfff; font-weight: bold; margin-bottom: 5px; font-size: 12px;">üìÖ VENCIMENTO</div>
                    <div style="color: aliceblue; font-size: 16px;">${dataVencimento}</div>
                </div>
            </div>
        `;
        
        detalhesReceita.style.display = 'block';
        
        // Atualizar valor m√°ximo do input
        const valorPagoInput = document.getElementById('valorPago');
        if (valorPagoInput) {
            const valorRestante = receita.valorRestante || receita.valorFinal || 0;
            valorPagoInput.max = valorRestante;
            valorPagoInput.setAttribute('max', valorRestante);
        }
    }
}

// Atualizar resumo do pagamento
document.addEventListener('DOMContentLoaded', function() {
    const valorPagoInput = document.getElementById('valorPago');
    const valorPagoDisplay = document.getElementById('valorPagoDisplay');
    const valorRestanteDisplay = document.getElementById('valorRestanteDisplay');
    const valorAposPagamento = document.getElementById('valorAposPagamento');
    const statusPagamento = document.getElementById('statusPagamento');
    const form = document.querySelector('.payment-form');
    const btnRegistrar = document.getElementById('btnRegistrarPagamento');
    const descontoPercentualInput = document.getElementById('descontoPercentual');
    const descontoValorInput = document.getElementById('descontoValor');
    const resumoDescontoWrap = document.getElementById('resumoDescontoWrap');
    const resumoDesconto = document.getElementById('resumoDesconto');
    
    function parseValorRestante() {
        if (!valorRestanteDisplay) return 0;
        const t = valorRestanteDisplay.textContent.replace('R$', '').trim().replace(/\./g, '').replace(',', '.');
        return parseFloat(t) || 0;
    }
    
    function atualizarResumo() {
        if (!valorPagoInput || !valorPagoDisplay) return;
        
        const valorPago = parseFloat(valorPagoInput.value) || 0;
        
        // Atualizar valor pago
        valorPagoDisplay.textContent = valorPago.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
        
        if (valorRestanteDisplay && valorAposPagamento && statusPagamento) {
            const valorRestante = parseValorRestante();
            
            // Calcular valor ap√≥s pagamento
            const valorApos = Math.max(0, valorRestante - valorPago);
            valorAposPagamento.textContent = valorApos.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
            
            // Atualizar status e campos ocultos
            const isParcialHidden = document.getElementById('isParcialHidden');
            const isIntegralHidden = document.getElementById('isIntegralHidden');
            
            if (valorApos <= 0) {
                statusPagamento.textContent = 'Integral';
                statusPagamento.style.color = '#28a745';
                if (isParcialHidden) isParcialHidden.value = 'false';
                if (isIntegralHidden) isIntegralHidden.value = 'true';
            } else {
                statusPagamento.textContent = 'Parcial';
                statusPagamento.style.color = '#ffc107';
                if (isParcialHidden) isParcialHidden.value = 'true';
                if (isIntegralHidden) isIntegralHidden.value = 'false';
            }
        }
    }
    
    function applyDiscount() {
        if (!descontoPercentualInput || !descontoValorInput || !valorPagoInput || !valorRestanteDisplay) return;
        const valorRestante = parseValorRestante();
        const pct = parseFloat(descontoPercentualInput.value) || 0;
        const valor = parseFloat(descontoValorInput.value) || 0;
        
        let discount = 0;
        let discountLabel = '';
        if (pct > 0) {
            discount = Math.min(valorRestante, valorRestante * pct / 100);
            descontoValorInput.value = '';
            descontoPercentualInput.value = pct;
            discountLabel = pct.toLocaleString('pt-BR', {minimumFractionDigits: 0, maximumFractionDigits: 2}) + '%';
        } else if (valor > 0) {
            discount = Math.min(valorRestante, valor);
            descontoPercentualInput.value = '';
            descontoValorInput.value = valor;
            discountLabel = valor.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
        }
        
        if (discount > 0) {
            const novoValorPago = Math.max(0, valorRestante - discount);
            valorPagoInput.value = novoValorPago.toFixed(2);
            if (resumoDescontoWrap) resumoDescontoWrap.style.display = '';
            if (resumoDesconto) resumoDesconto.textContent = discountLabel;
        } else {
            valorPagoInput.value = valorRestante.toFixed(2);
            if (resumoDescontoWrap) resumoDescontoWrap.style.display = 'none';
            if (resumoDesconto) resumoDesconto.textContent = '‚Äî';
            descontoPercentualInput.value = '';
            descontoValorInput.value = '';
        }
        atualizarResumo();
    }
    
    if (valorPagoInput) {
        valorPagoInput.addEventListener('input', atualizarResumo);
        atualizarResumo();
    }
    
    if (descontoPercentualInput) {
        descontoPercentualInput.addEventListener('input', applyDiscount);
        descontoPercentualInput.addEventListener('change', applyDiscount);
    }
    if (descontoValorInput) {
        descontoValorInput.addEventListener('input', applyDiscount);
        descontoValorInput.addEventListener('change', applyDiscount);
    }
    
    if (descontoPercentualInput && descontoValorInput) {
        const pct = parseFloat(descontoPercentualInput.value) || 0;
        const valor = parseFloat(descontoValorInput.value) || 0;
        if (pct > 0 || valor > 0) applyDiscount();
    }
    
    // Controlar visibilidade do campo tipoPagamento
    function atualizarVisibilidadeTipoPagamento() {
        const tipoPagamentoGroup = document.getElementById('tipoPagamentoGroup');
        const parcelaIdHidden = document.getElementById('parcelaIdHidden');
        const receitaIdHidden = document.getElementById('receitaIdHidden');
        const tipoPagamentoSelect = document.getElementById('tipoPagamento');
        
        if (tipoPagamentoGroup && tipoPagamentoSelect) {
            // Ocultar se vier de mensalidade (parcelaId) ou se j√° tiver receita selecionada
            const temParcelaId = parcelaIdHidden && parcelaIdHidden.value && parcelaIdHidden.value.trim() !== '';
            const temReceitaId = receitaIdHidden && receitaIdHidden.value && receitaIdHidden.value.trim() !== '';
            
            if (temParcelaId || temReceitaId) {
                tipoPagamentoGroup.style.display = 'none';
                // Remover required e limpar valor quando oculto
                tipoPagamentoSelect.removeAttribute('required');
                tipoPagamentoSelect.value = '';
            } else {
                tipoPagamentoGroup.style.display = 'block';
                // Adicionar required quando vis√≠vel
                tipoPagamentoSelect.setAttribute('required', 'required');
            }
        }
    }
    
    // Atualizar visibilidade ao carregar a p√°gina
    atualizarVisibilidadeTipoPagamento();
    
    // Atualizar quando receita for selecionada
    const receitaSelect = document.getElementById('receitaSelect');
    if (receitaSelect) {
        receitaSelect.addEventListener('change', function() {
            atualizarVisibilidadeTipoPagamento();
        });
    }
    
    // Adicionar event listener ao formul√°rio para calcular campos antes do submit e validar
    if (form) {
        form.addEventListener('submit', function(event) {
            // IMPORTANTE: Remover required de campos ocultos ANTES da valida√ß√£o HTML5
            const tipoPagamentoGroup = document.getElementById('tipoPagamentoGroup');
            const tipoPagamentoSelect = document.getElementById('tipoPagamento');
            
            if (tipoPagamentoGroup && tipoPagamentoSelect) {
                // Se o campo est√° oculto, remover required para evitar erro de foco
                if (tipoPagamentoGroup.style.display === 'none' || 
                    window.getComputedStyle(tipoPagamentoGroup).display === 'none') {
                    tipoPagamentoSelect.removeAttribute('required');
                }
            }
            
            // Validar se receitaId ou parcelaId est√° preenchido
            const receitaIdHidden = document.getElementById('receitaIdHidden');
            const parcelaIdHidden = document.getElementById('parcelaIdHidden');
            
            const receitaId = receitaIdHidden ? receitaIdHidden.value : null;
            const parcelaId = parcelaIdHidden ? parcelaIdHidden.value : null;
            
            // Se n√£o h√° receitaId nem parcelaId, verificar se tem tipoPagamento e dados necess√°rios
            if ((!receitaId || receitaId.trim() === '') && (!parcelaId || parcelaId.trim() === '')) {
                const tipoPagamento = document.getElementById('tipoPagamento');
                const alunoSelect = document.getElementById('alunoSelect');
                
                // Se tem tipoPagamento selecionado, permitir criar receita automaticamente
                if (tipoPagamento && tipoPagamento.value && alunoSelect && alunoSelect.value) {
                    // Validar se tipoPagamento est√° selecionado
                    if (!tipoPagamento.value) {
                        event.preventDefault();
                        event.stopPropagation();
                        alert('‚ö†Ô∏è Por favor, selecione o tipo de pagamento (Mensalidade, Material ou Outros).');
                        tipoPagamento.focus();
                        return false;
                    }
                    // Permitir continuar - receita ser√° criada no backend
                } else {
                event.preventDefault();
                event.stopPropagation();
                
                // Verificar se existe seletor de aluno (indica que precisa selecionar receita)
                const alunoSelect = document.getElementById('alunoSelect');
                const receitaSelect = document.getElementById('receitaSelect');
                
                if (alunoSelect && receitaSelect) {
                    // Est√° na se√ß√£o de sele√ß√£o manual
                    if (!alunoSelect.value) {
                        alert('‚ö†Ô∏è Por favor, selecione um aluno antes de registrar o pagamento.');
                        alunoSelect.focus();
                    } else if (!receitaSelect.value) {
                        alert('‚ö†Ô∏è Por favor, selecione uma receita antes de registrar o pagamento.');
                        receitaSelect.focus();
                    } else {
                        alert('‚ö†Ô∏è Erro: Receita n√£o selecionada corretamente. Por favor, selecione uma receita novamente.');
                        receitaSelect.focus();
                    }
                } else {
                    // N√£o est√° na se√ß√£o de sele√ß√£o (deveria ter receita pr√©-selecionada)
                    alert('‚ö†Ô∏è Erro: Receita ou mensalidade n√£o selecionada. Por favor, acesse o pagamento atrav√©s de uma receita ou mensalidade espec√≠fica.');
                }
                return false;
            }
            
            // Calcular campos ocultos antes de enviar
            calcularCamposOcultos();
        });
    }
    
    // Verificar se h√° erro ou sucesso
    const errorFlash = /*[[${error}]]*/ null;
    const successFlash = /*[[${success}]]*/ null;
    
    if (errorFlash) {
        mostrarMensagem('Erro', errorFlash);
    } else if (successFlash) {
        mostrarMensagem('Sucesso', successFlash);
    }
});

function mostrarMensagem(titulo, mensagem) {
    document.getElementById('messageTitle').textContent = titulo;
    document.getElementById('messageText').textContent = mensagem;
    document.getElementById('messageModal').style.display = 'flex';
}

function fecharModal() {
    document.getElementById('messageModal').style.display = 'none';
}

// Fechar modal ao clicar no X
document.addEventListener('DOMContentLoaded', function() {
    const closeBtn = document.querySelector('.close');
    if (closeBtn) {
        closeBtn.onclick = fecharModal;
    }
});

// Fechar modal ao clicar fora dele
window.onclick = function(event) {
    const modal = document.getElementById('messageModal');
    if (event.target === modal) {
        fecharModal();
    }
}
/*]]>*/
</script>

</body>
</html>
