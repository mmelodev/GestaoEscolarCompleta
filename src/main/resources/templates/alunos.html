<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
    <title>Alunos - AriranG</title>
    <link rel="stylesheet" th:href="@{/css/home.css?v=2.0}" />
    <link rel="stylesheet" th:href="@{/css/header.css?v=2.0}" />
    <link rel="stylesheet" th:href="@{/css/alunos.css?v=1.3}" />
    <link rel="stylesheet" th:href="@{/css/alunos-lista-styles.css?v=1.0}" />
</head>
<body>
<header>
    <div class="main-nav">
        <div class="logo">
            <a th:href="@{/}"><img th:src="@{/img/horizontal_negativa.png}" alt="Logo AriranG" /></a>
        </div>
        <nav>
            <!-- Bot√£o Hamb√∫rguer - Mobile -->
            <button class="menu-toggle" id="menuToggle" aria-label="Abrir menu" aria-expanded="false" aria-controls="navList">
                <span></span>
                <span></span>
                <span></span>
            </button>
            
            <ul class="nav-list" id="navList">
                <a th:href="@{/}"><li class="nav-element">Home</li></a>
                <a sec:authorize="hasAnyRole('ADMIN', 'USER')" th:href="@{/alunos/lista}"><li class="nav-element active">Alunos</li></a>
                <a sec:authorize="hasAnyRole('ADMIN', 'USER')" th:href="@{/turmas}"><li class="nav-element">Turmas</li></a>
                <a sec:authorize="hasAnyRole('ADMIN', 'USER')" th:href="@{/frequencia}"><li class="nav-element">üìä Frequ√™ncia</li></a>
                <a sec:authorize="isAuthenticated()" th:href="@{/cadastro}"><li class="nav-element">Cadastro</li></a>
                <a sec:authorize="isAuthenticated()" th:href="@{/perfil}"><li class="nav-element">Meu Perfil</li></a>
                <li class="nav-element" sec:authorize="isAuthenticated()">
                    <form th:action="@{/logout}" method="post" class="nav-logout-form">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <button type="submit" class="logout-button" aria-label="Encerrar sess√£o">Sair</button>
                    </form>
                </li>
                <a sec:authorize="!isAuthenticated()" th:href="@{/login}"><li class="nav-element">Login</li></a>
            </ul>
            <div sec:authorize="isAuthenticated()" class="user-badge">
                <span class="user-badge__icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="8" r="4"></circle>
                        <path d="M4 20a8 8 0 0 1 8-8 8 8 0 0 1 8 8"></path>
                        <path d="M16 18h5v-2.5a2.5 2.5 0 0 0-5 0V18z"></path>
                        <path d="M16 15.5V18"></path>
                    </svg>
                </span>
                <span class="user-badge__label">Perfil</span>
                <span class="user-badge__name" sec:authentication="name"></span>
            </div>
        </nav>
    </div>
    <!-- Overlay para fechar menu ao clicar fora - Fora do nav para melhor posicionamento -->
    <div class="menu-overlay" id="menuOverlay" aria-hidden="true"></div>
</header>

<main>
    <section class="alunos-header">
        <h1>Gerenciamento de Alunos</h1>
        <div class="top-actions">
            <form method="get" th:action="@{/alunos/lista}" class="filter-form">
                <input type="text" name="search" placeholder="Pesquisar..." class="search-bar" th:value="${searchTerm}" />
                <label for="turmaId">Turma</label>
                <select id="turmaId" name="turmaId" class="select-filter">
                    <option th:value="${null}" th:selected="${turmaSelecionada == null}">Todas</option>
                    <option th:each="t : ${turmas}"
                            th:value="${t.id}"
                            th:selected="${turmaSelecionada} == ${t.id}"
                            th:text="${t.nomeTurma}"></option>
                </select>
                <label for="situacao">Situa√ß√£o</label>
                <select id="situacao" name="situacao" class="select-filter">
                    <option value="" th:selected="${situacaoSelecionada == null or situacaoSelecionada.isEmpty()}">Todas</option>
                    <option value="ATIVO" th:selected="${situacaoSelecionada == 'ATIVO'}">Ativo</option>
                    <option value="INATIVO" th:selected="${situacaoSelecionada == 'INATIVO'}">Inativo</option>
                    <option value="TRANCADO" th:selected="${situacaoSelecionada == 'TRANCADO'}">Trancado</option>
                    <option value="FORMADO" th:selected="${situacaoSelecionada == 'FORMADO'}">Formado</option>
                    <option value="DESISTENTE" th:selected="${situacaoSelecionada == 'DESISTENTE'}">Desistente</option>
                </select>
                <button type="submit" class="btn cadastrar">Filtrar</button>
                <a th:href="@{/alunos/lista}" class="btn cadastrar">Limpar</a>
            </form>
            <a th:href="@{/alunos/novo}" class="btn cadastrar">+ Cadastrar Aluno</a>
        </div>
    </section>

    <section class="tabela-container">
        <div th:if="${alunos != null && !alunos.empty}" class="table-responsive">
            <table>
                <thead>
                <tr>
                    <th>Nome</th>
                    <th>E-mail</th>
                    <th>Telefone</th>
                    <th>Turma</th>
                    <th>Situa√ß√£o</th>
                    <th>A√ß√µes</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="aluno : ${alunos}">
                    <td data-label="Nome" th:text="${aluno.nomeCompleto}"></td>
                    <td data-label="E-mail" th:text="${aluno.email}"></td>
                    <td data-label="Telefone" th:text="${aluno.telefone}"></td>
                    <td data-label="Turma">
                        <div th:if="${aluno.turmaIds != null && !aluno.turmaIds.isEmpty()}" style="display: flex; flex-direction: column; gap: 5px;">
                            <div th:each="turmaId, iterStat : ${aluno.turmaIds}" style="display: flex; align-items: center; gap: 8px;">
                                <span th:text="${aluno.turmaNomes[iterStat.index]}"></span>
                                <form th:action="@{/alunos/{id}/turmas/{turmaId}/remover(id=${aluno.id}, turmaId=${turmaId})}" 
                                      method="post" 
                                      style="display: inline-block; margin: 0;"
                                      onsubmit="return confirm('Tem certeza que deseja remover este aluno da turma? O aluno ficar√° inativo se n√£o tiver mais turmas.');">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                    <input type="hidden" name="redirect" th:value="@{/alunos/lista}" />
                                    <button type="submit" class="btn deletar" style="padding: 2px 8px; font-size: 0.85em; margin: 0;" title="Remover da turma">‚úï</button>
                                </form>
                            </div>
                        </div>
                        <span th:if="${aluno.turmaNomes == null or aluno.turmaNomes.isEmpty()}">-</span>
                    </td>
                    <td data-label="Situa√ß√£o">
                        <span class="situacao-badge" 
                              th:classappend="${aluno.situacao == 'ATIVO'} ? 'situacao-ativo' : 
                                             (${aluno.situacao == 'INATIVO'} ? 'situacao-inativo' : 
                                             (${aluno.situacao == 'TRANCADO'} ? 'situacao-trancado' : 
                                             (${aluno.situacao == 'FORMADO'} ? 'situacao-formado' : 
                                             (${aluno.situacao == 'DESISTENTE'} ? 'situacao-desistente' : 'situacao-indefinida'))))"
                              th:text="${aluno.situacao != null && !aluno.situacao.isEmpty() ? aluno.situacao : 'N√£o definida'}">
                        </span>
                    </td>
                    <td data-label="A√ß√µes" class="acoes">
                        <a th:href="@{/alunos/editar/{id}(id=${aluno.id})}" class="btn editar">Editar</a>
                        <a th:href="@{/alunos/deletar/{id}(id=${aluno.id})}" class="btn deletar">Deletar</a>
                        <a th:href="@{/alunos/turma/{id}(id=${aluno.id})}" class="btn turma">Turma</a>
                        <a th:href="@{/alunos/situacao/{id}(id=${aluno.id})}" class="btn turma">Situa√ß√£o</a>
                        <a th:href="@{'/cracha/' + ${aluno.id}}" class="btn cadastrar">Crach√°</a>
                        <a th:if="${aluno.turmaIds != null && !aluno.turmaIds.isEmpty()}" 
                           th:href="@{'/boletim/aluno/' + ${aluno.id} + '/turma/' + ${aluno.turmaIds[0]}}" 
                           class="btn turma">Lan√ßar Boletim</a>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
        
        <div th:if="${alunos == null || alunos.empty}" class="empty-state">
            <div class="empty-state-content">
                <h3>Nenhum aluno encontrado</h3>
                <p th:if="${searchTerm != null and !searchTerm.isEmpty()}">
                    N√£o foram encontrados alunos com o termo "<strong th:text="${searchTerm}"></strong>".
                </p>
                <p th:unless="${searchTerm != null and !searchTerm.isEmpty()}">
                    Ainda n√£o h√° alunos cadastrados na plataforma.
                </p>
                <a th:href="@{/alunos/novo}" class="btn cadastrar">+ Cadastrar Primeiro Aluno</a>
                <a th:href="@{/alunos/lista}" class="btn turma">Ver Todos os Alunos</a>
            </div>
        </div>
    </section>
</main>

<footer class="page-footer">
    <div class="footer-content">
        <p class="footer-text">
            ¬© <span th:text="${#temporals.format(#temporals.createNow(), 'yyyy')}">2024</span> AriranG - Instituto de Idiomas
        </p>
        <p class="footer-text footer-subtitle">
            Plataforma de gest√£o acad√™mica e administrativa
        </p>
    </div>
</footer>

<!-- Modal de Erro/Sucesso -->
<div id="messageModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h3 id="messageTitle"></h3>
        <p id="messageText"></p>
        <button onclick="fecharModal()" class="btn">OK</button>
    </div>
</div>

<script th:inline="javascript">
/* ============================================
   MENU HAMB√öRGUER - Mobile Navigation
   ============================================ */
document.addEventListener('DOMContentLoaded', function() {
    const menuToggle = document.getElementById('menuToggle');
    const navList = document.getElementById('navList');
    const menuOverlay = document.getElementById('menuOverlay');
    const body = document.body;
    let scrollYBeforeMenu = 0;

    if (menuToggle && navList) {
        function lockPageScroll() {
            scrollYBeforeMenu = window.pageYOffset || document.documentElement.scrollTop || 0;
            body.dataset.scrollYBeforeMenu = String(scrollYBeforeMenu);
            body.style.position = 'fixed';
            body.style.top = `-${scrollYBeforeMenu}px`;
            body.style.left = '0';
            body.style.right = '0';
            body.style.width = '100%';
            body.style.overflow = 'hidden';
        }

        function unlockPageScroll() {
            const y = parseInt(body.dataset.scrollYBeforeMenu || '0', 10) || 0;
            body.style.position = '';
            body.style.top = '';
            body.style.left = '';
            body.style.right = '';
            body.style.width = '';
            body.style.overflow = '';
            delete body.dataset.scrollYBeforeMenu;
            window.scrollTo(0, y);
        }

        // Fun√ß√£o para abrir/fechar menu
        function toggleMenu() {
            const isOpen = navList.classList.contains('menu-open');
            
            if (isOpen) {
                closeMenu();
            } else {
                openMenu();
            }
        }

        // Fun√ß√£o para abrir menu
        function openMenu() {
            navList.classList.add('menu-open');
            menuToggle.classList.add('active');
            menuToggle.setAttribute('aria-expanded', 'true');
            if (menuOverlay) {
                menuOverlay.classList.add('active');
                menuOverlay.setAttribute('aria-hidden', 'false');
            }
            if (window.innerWidth < 1024) {
                lockPageScroll();
            }
        }

        // Fun√ß√£o para fechar menu
        function closeMenu() {
            navList.classList.remove('menu-open');
            menuToggle.classList.remove('active');
            menuToggle.setAttribute('aria-expanded', 'false');
            if (menuOverlay) {
                menuOverlay.classList.remove('active');
                menuOverlay.setAttribute('aria-hidden', 'true');
            }
            unlockPageScroll();
        }

        // Event listener no bot√£o hamb√∫rguer
        menuToggle.addEventListener('click', function(e) {
            e.stopPropagation();
            toggleMenu();
        });

        // Fechar menu ao clicar no overlay
        if (menuOverlay) {
            menuOverlay.addEventListener('click', closeMenu);
        }

        // Fechar menu ao clicar em um link (mobile)
        const navLinks = navList.querySelectorAll('a');
        navLinks.forEach(link => {
            link.addEventListener('click', function() {
                if (window.innerWidth < 1024) {
                    closeMenu();
                }
            });
        });

        // Fechar menu ao clicar no bot√£o logout (mobile)
        const logoutButton = navList.querySelector('.logout-button');
        if (logoutButton) {
            logoutButton.addEventListener('click', function() {
                if (window.innerWidth < 1024) {
                    closeMenu();
                }
            });
        }

        // Fechar menu ao pressionar ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && navList.classList.contains('menu-open')) {
                closeMenu();
                menuToggle.focus();
            }
        });

        // Fechar menu ao redimensionar janela (se passar para desktop)
        let resizeTimer;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(function() {
                if (window.innerWidth >= 1024 && navList.classList.contains('menu-open')) {
                    closeMenu();
                }
            }, 250);
        });
    }

    // ============================================
    // Modal de Erro/Sucesso
    // ============================================
    /*<![CDATA[*/
    // Fun√ß√µes do Modal (definidas primeiro para uso abaixo)
    function mostrarMensagem(titulo, mensagem) {
        const modal = document.getElementById('messageModal');
        const titleEl = document.getElementById('messageTitle');
        const textEl = document.getElementById('messageText');
        if (modal && titleEl && textEl) {
            titleEl.textContent = titulo;
            textEl.textContent = mensagem;
            modal.style.display = 'flex';
        }
    }

    function fecharModal() {
        const modal = document.getElementById('messageModal');
        if (modal) {
            modal.style.display = 'none';
        }
    }

    // Tornar fun√ß√µes dispon√≠veis globalmente
    window.fecharModal = fecharModal;
    window.mostrarMensagem = mostrarMensagem;

    // Verificar se h√° erro ou sucesso (via flash attribute ou URL)
    const errorFlash = /*[[${error}]]*/ null;
    const successFlash = /*[[${success}]]*/ null;
    
    if (errorFlash) {
        mostrarMensagem('Erro', errorFlash);
    } else if (successFlash) {
        mostrarMensagem('Sucesso', successFlash);
    } else {
        // Fallback: verificar URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const error = urlParams.get('error');
        const success = urlParams.get('success');
        
        if (error) {
            // Decodificar corretamente caracteres especiais
            const errorDecoded = decodeURIComponent(error.replace(/\+/g, ' '));
            mostrarMensagem('Erro', errorDecoded);
            // Limpar a URL removendo o par√¢metro de erro
            const url = new URL(window.location);
            url.searchParams.delete('error');
            window.history.replaceState({}, document.title, url);
        } else if (success) {
            // Decodificar corretamente caracteres especiais
            const successDecoded = decodeURIComponent(success.replace(/\+/g, ' '));
            mostrarMensagem('Sucesso', successDecoded);
            // Limpar a URL removendo o par√¢metro de sucesso
            const url = new URL(window.location);
            url.searchParams.delete('success');
            window.history.replaceState({}, document.title, url);
        }
    }

    // Fechar modal ao clicar no X
    const closeBtn = document.querySelector('.close');
    if (closeBtn) {
        closeBtn.addEventListener('click', fecharModal);
    }

    // Fechar modal ao clicar fora dele
    window.addEventListener('click', function(event) {
        const modal = document.getElementById('messageModal');
        if (event.target === modal && modal) {
            fecharModal();
        }
    });
    /*]]>*/
});
</script>

</body>
</html>